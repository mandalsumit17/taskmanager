<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Task Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Material+Icons" rel="stylesheet">
    <style>
        /* --- Global Styles --- */
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            background: linear-gradient(120deg, #f5f7fa 0%, #c3cfe2 100%);
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0; padding: 0;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            overflow-x: hidden;
            box-shadow: 0 0 0 100vw #e3eafc22 inset;
            animation: bodyFadeIn 0.7s cubic-bezier(.4,2,.6,1);
        }
        @keyframes bodyFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        body::before {
            content: "";
            position: fixed;
            top: -10vh; left: -10vw; right: -10vw; bottom: -10vh;
            background: radial-gradient(circle at 80% 10%, #b6e0fe 0%, transparent 60%),
                        radial-gradient(circle at 10% 90%, #fbc2eb 0%, transparent 70%);
            opacity: 0.22;
            z-index: 0;
            pointer-events: none;
            animation: bgmove 18s linear infinite alternate;
            filter: blur(2px) saturate(120%);
        }
        @keyframes bgmove {
            0% { background-position: 80% 10%, 10% 90%; }
            100% { background-position: 60% 20%, 20% 80%; }
        }
        h1 {
            text-align: center;
            font-weight: 900;
            letter-spacing: 2.5px;
            margin-top: 48px;
            margin-bottom: 28px;
            color: #22334d;
            font-size: 2.7rem;
            text-shadow: 0 6px 32px rgba(44,62,80,0.13);
            background: linear-gradient(90deg, #3b82f6 10%, #43a047 90%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: font-size 0.2s;
            letter-spacing: 2.5px;
            user-select: none;
        }

        /* --- Glassmorphism Card Styles --- */
        .task-form, .controls, .task-item, .modal-box {
            backdrop-filter: blur(18px) saturate(160%);
            background: rgba(255,255,255,0.92);
            border: 1.5px solid rgba(227,234,252,0.85);
            box-shadow: 0 8px 32px 0 rgba(44,62,80,0.13), 0 1.5px 0 #e3eafc;
            transition: box-shadow 0.22s, border-color 0.22s, background 0.18s;
        }

        /* --- Task Form Styles --- */
        .task-form {
            padding: 44px 38px 28px 38px;
            border-radius: 24px;
            box-shadow: 0 12px 48px 0 rgba(44,62,80,0.18), 0 1.5px 0 #e3eafc;
            max-width: 500px;
            margin: 0 auto 36px;
            display: flex;
            flex-direction: column;
            gap: 22px;
            position: relative;
            z-index: 1;
            border: none;
        }
        .task-form:focus-within {
            box-shadow: 0 20px 60px rgba(44,62,80,0.26);
            border-color: #3b82f6;
            background: rgba(255,255,255,0.99);
        }
        .task-form input, .task-form select {
            width: 100%;
            margin: 0;
            padding: 16px 18px;
            border: 1.5px solid #d1d9e6;
            border-radius: 10px;
            font-size: 1.13rem;
            background: rgba(247,250,253,0.98);
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            outline: none;
            color: #22334d;
            box-shadow: 0 1px 6px rgba(44,62,80,0.06);
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        .task-form input:focus, .task-form select:focus {
            border-color: #3b82f6;
            background: #fff;
            box-shadow: 0 2px 16px rgba(91,157,249,0.16);
        }
        /* Validation error styles */
        .task-form input.error, .task-form select.error {
            border-color: #e53935;
            box-shadow: 0 0 0 2px rgba(229, 57, 53, 0.2);
        }
        .error-message {
            color: #e53935;
            font-size: 0.88rem;
            margin-top: -16px; /* Adjust to sit closer to input */
            margin-bottom: 0px;
            display: block; /* Ensures it takes up space even if empty */
            min-height: 18px; /* Prevents layout shift */
            font-weight: 500;
            transition: opacity 0.2s ease-out;
            opacity: 0;
        }
        .error-message.active {
            opacity: 1;
        }

        .task-form .inline {
            display: flex;
            gap: 14px;
        }
        .task-form .inline > * { flex: 1; }
        .task-form button {
            width: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 16px 0;
            font-size: 1.18rem;
            font-weight: 800;
            letter-spacing: 1px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 2px 16px rgba(91,157,249,0.13);
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            text-shadow: 0 1px 2px rgba(44,62,80,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            outline: none;
            font-family: inherit;
        }
        .task-form button:hover, .task-form button:focus {
            background: linear-gradient(90deg, #2563eb 0%, #43a047 100%);
            box-shadow: 0 8px 32px rgba(91,157,249,0.18);
            transform: translateY(-1px) scale(1.02); /* Adjusted for subtle lift */
        }
        .task-form button:active {
            transform: translateY(1px) scale(1.00); /* Press down effect */
            box-shadow: 0 2px 8px rgba(91,157,249,0.08);
        }

        /* --- Task List Styles --- */
        .controls {
            max-width: 500px;
            margin: 0 auto 24px; /* Reduced bottom margin slightly */
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            padding: 18px 22px;
            border-radius: 14px;
            box-shadow: 0 2px 16px rgba(44,62,80,0.09);
            align-items: center;
            position: relative;
            z-index: 1;
            border: none;
        }
        .controls input[type="text"] {
            flex: 2; /* Search bar takes more space */
            min-width: 150px;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1.5px solid #d1d9e6;
            background: rgba(247,250,253,0.98);
            font-size: 1.09rem;
            color: #22334d;
            transition: border 0.2s, background 0.2s, box-shadow 0.2s;
            font-weight: 500;
            outline: none;
            box-shadow: 0 1px 6px rgba(44,62,80,0.06);
        }
        .controls input[type="text"]:focus {
            border-color: #3b82f6;
            background: #fff;
            box-shadow: 0 2px 16px rgba(91,157,249,0.16);
        }
        .controls select {
            flex: 1;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1.5px solid #d1d9e6;
            background: rgba(247,250,253,0.98);
            font-size: 1.09rem;
            color: #22334d;
            transition: border 0.2s, background 0.2s, box-shadow 0.2s;
            font-weight: 500;
            outline: none;
            box-shadow: 0 1px 6px rgba(44,62,80,0.06);
        }
        .controls select:focus {
            border-color: #3b82f6;
            background: #fff;
            box-shadow: 0 2px 16px rgba(91,157,249,0.16);
        }
        .controls button {
            background: #e53935; /* Red for delete */
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 1.0rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(229,57,53,0.1);
            transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
            outline: none;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .controls button:hover, .controls button:focus {
            background: #d32f2f;
            box-shadow: 0 4px 16px rgba(229,57,53,0.18);
            transform: translateY(-1px) scale(1.02);
        }
        .controls button:active {
            transform: translateY(1px) scale(1.00);
            box-shadow: 0 1px 6px rgba(229,57,53,0.08);
        }


        .task-list {
            max-width: 500px; /* Aligned with form/controls */
            width: 100%;
            margin: 0 auto 48px; /* Consistent margin */
            z-index: 1;
            position: relative;
        }
        .task-item {
            padding: 24px 24px 18px 24px;
            margin-bottom: 18px;
            border-left: 8px solid;
            display: flex;
            flex-direction: column;
            border-radius: 14px;
            box-shadow: 0 6px 32px rgba(44,62,80,0.13);
            transition: background 0.25s, box-shadow 0.18s, border-color 0.18s, transform 0.13s, opacity 0.3s ease-out;
            border-color: #e3eafc;
            position: relative;
            overflow: hidden;
            z-index: 1;
            animation: fadeInUp 0.4s cubic-bezier(.4,2,.6,1);
            background: rgba(255,255,255,0.97);
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(24px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .task-item.deleting {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .task-item:hover {
            background: rgba(247,250,253,1);
            box-shadow: 0 12px 48px rgba(44,62,80,0.18);
            border-color: #3b82f6;
            transform: translateY(-2px) scale(1.012);
        }
        .task-item.completed {
            background: linear-gradient(90deg, #eafbe7 60%, #f7fafd 100%);
            text-decoration: line-through;
            opacity: 0.7;
            border-color: #43a047;
            filter: grayscale(0.15) brightness(1.05);
        }
        /* New due date highlighting */
        .task-item.overdue {
            border-color: #ef5350 !important; /* Lighter red */
            background: linear-gradient(90deg, #ffe0e0 60%, #f7fafd 100%);
            box-shadow: 0 6px 32px rgba(239, 83, 80, 0.13);
        }
        .task-item.due-soon {
            border-color: #ffb74d !important; /* Lighter orange */
            background: linear-gradient(90deg, #fff7e0 60%, #f7fafd 100%);
            box-shadow: 0 6px 32px rgba(255, 183, 77, 0.13);
        }


        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 18px;
        }
        .task-header strong {
            font-size: 1.18rem;
            color: #22334d;
            font-weight: 800;
            letter-spacing: 0.7px;
            margin-bottom: 2px;
            display: block;
            line-height: 1.2;
            word-break: break-word;
        }
        .task-header small {
            color: #7b8a9c;
            font-size: 1.01rem;
            display: block;
            margin-top: 6px;
            font-weight: 600;
            letter-spacing: 0.2px;
            line-height: 1.4;
            word-break: break-word;
        }
        .task-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 2px;
        }
        .task-actions button {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 1.35rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.15s, color 0.15s, box-shadow 0.15s, border 0.15s, transform 0.12s;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            border: 1.5px solid transparent;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
        }
        .task-actions button:hover, .task-actions button:focus {
            background: #e3eafc;
            color: #2563eb;
            border-color: #3b82f6;
            box-shadow: 0 2px 12px rgba(91,157,249,0.13);
            transform: scale(1.08) translateY(-1px); /* Subtle lift */
        }
        .task-actions button:active {
            transform: scale(1.05) translateY(1px); /* Press down */
            box-shadow: 0 1px 8px rgba(91,157,249,0.08);
        }

        .task-actions input[type="checkbox"] {
            accent-color: #43a047;
            width: 22px; height: 22px;
            margin-right: 6px;
            cursor: pointer;
            border-radius: 5px;
            border: 1.5px solid #d1d9e6;
            transition: border 0.15s, box-shadow 0.15s;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
        }
        .task-actions input[type="checkbox"]:focus {
            border-color: #43a047;
            outline: none;
            box-shadow: 0 2px 8px rgba(67,160,71,0.13);
        }
        .priority-Urgent { border-color: #e53935 !important; }
        .priority-High { border-color: #f57c00 !important; }
        .priority-Medium { border-color: #fbc02d !important; }
        .priority-Low { border-color: #43a047 !important; }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(44,62,80,0.28);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.18s;
            backdrop-filter: blur(5px) saturate(140%); /* Slightly more blur */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-box {
            background: rgba(255,255,255,0.99);
            padding: 44px 32px 28px 32px;
            border-radius: 18px;
            box-shadow: 0 20px 80px rgba(44,62,80,0.32);
            text-align: center;
            min-width: 320px;
            max-width: 96vw;
            border: 1.5px solid #e3eafc;
            animation: popIn 0.22s cubic-bezier(.4,2,.6,1);
            position: relative;
            z-index: 1001;
        }
        @keyframes popIn {
            from { transform: scale(0.92); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-box p {
            font-size: 1.18rem;
            margin-bottom: 28px;
            color: #22334d;
            font-weight: 700;
            letter-spacing: 0.4px;
        }
        .modal-box button {
            margin: 0 14px;
            padding: 12px 32px;
            border-radius: 10px;
            border: none;
            font-size: 1.09rem;
            font-weight: 800;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.12s;
            box-shadow: 0 2px 12px rgba(44,62,80,0.09);
            outline: none;
        }
        .modal-box #yes, .modal-box #confirmClear, .modal-box #saveEdit { /* Consolidated positive actions */
            background: linear-gradient(90deg, #3b82f6 0%, #43a047 100%); /* Changed to blue/green for save/confirm */
            color: #fff;
        }
        .modal-box #yes:hover, .modal-box #yes:focus, .modal-box #confirmClear:hover, .modal-box #confirmClear:focus, .modal-box #saveEdit:hover, .modal-box #saveEdit:focus {
            background: linear-gradient(90deg, #2563eb 0%, #388e3c 100%); /* Darker on hover */
            box-shadow: 0 4px 24px rgba(91,157,249,0.18);
            transform: scale(1.04) translateY(-1px);
        }
        .modal-box #yes:active, .modal-box #confirmClear:active, .modal-box #saveEdit:active {
            transform: scale(1.02) translateY(1px);
            box-shadow: 0 1px 8px rgba(91,157,249,0.08);
        }

        .modal-box #no, .modal-box #cancelClear, .modal-box #cancelEdit { /* Consolidated negative actions */
            background: #e3eafc;
            color: #22334d;
        }
        .modal-box #no:hover, .modal-box #no:focus, .modal-box #cancelClear:hover, .modal-box #cancelClear:focus, .modal-box #cancelEdit:hover, .modal-box #cancelEdit:focus {
            background: #d1d9e6;
            color: #22334d;
            transform: scale(1.04) translateY(-1px);
        }
        .modal-box #no:active, .modal-box #cancelClear:active, .modal-box #cancelEdit:active {
            transform: scale(1.02) translateY(1px);
            box-shadow: 0 1px 8px rgba(44,62,80,0.08);
        }

        /* Edit Modal Specific Styles */
        .modal-box.edit-modal {
            text-align: left;
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .modal-box.edit-modal input, .modal-box.edit-modal select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #d1d9e6;
            border-radius: 8px;
            font-size: 1.05rem;
            background: rgba(247,250,253,0.98);
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            outline: none;
            color: #22334d;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
            font-weight: 500;
        }
        .modal-box.edit-modal input:focus, .modal-box.edit-modal select:focus {
            border-color: #3b82f6;
            background: #fff;
            box-shadow: 0 2px 12px rgba(91,157,249,0.13);
        }
        .modal-box.edit-modal h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #22334d;
            font-size: 1.6rem;
            font-weight: 800;
            text-align: center;
        }
        .modal-box.edit-modal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .modal-box.edit-modal .modal-buttons button {
            flex: 1; /* Make buttons take equal space */
            max-width: 150px;
        }
        .modal-box.edit-modal label {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 6px;
            display: block;
            font-weight: 600;
            letter-spacing: 0.1px;
        }


        /* --- Responsive Layout --- */
        @media (max-width: 700px) {
            .task-form, .controls, .task-list, .modal-box { max-width: 99vw; margin-left: 5px; margin-right: 5px;}
            .task-form { padding: 24px 18px 18px 18px; }
            .controls { padding: 14px 10px; flex-direction: column; align-items: stretch;}
            .controls select, .controls button, .controls input[type="text"] { width: 100%;}
            .task-item { padding: 18px 18px 14px 18px; }
            .modal-box { min-width: 90vw; }
            h1 { font-size: 2rem; margin-top: 32px; margin-bottom: 24px; }
            .modal-box.edit-modal { padding: 20px; }
            .modal-box.edit-modal .modal-buttons { flex-direction: column; gap: 10px;}
        }
        @media (max-width: 500px) {
            h1 { font-size: 1.6rem; margin-top: 20px; margin-bottom: 18px; letter-spacing: 1.5px;}
            .task-form { padding: 16px 12px; gap: 16px; }
            .task-form input, .task-form select { padding: 12px 14px; font-size: 1rem;}
            .task-form button { padding: 14px 0; font-size: 1.1rem; }
            .controls { padding: 10px 8px; }
            .task-item { padding: 12px 12px 10px 12px; }
            .task-header strong { font-size: 1.05rem; }
            .task-header small { font-size: 0.95rem; }
            .task-actions button { font-size: 1.2rem; padding: 6px;}
            .task-actions .material-icons { font-size: 1.2rem;}
            .modal-box { padding: 20px 15px; }
            .modal-box p { font-size: 1rem; margin-bottom: 20px;}
            .modal-box button { margin: 0 8px; padding: 10px 24px; font-size: 1rem;}
        }

        /* --- Custom: Empty State --- */
        .task-list .empty-state {
            color: #8b95a8;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-top: 48px;
            margin-bottom: 48px;
            text-shadow: 0 2px 8px #e3eafc;
            opacity: 0.85;
            text-align: center;
            line-height: 1.6;
        }
        .task-list .empty-state .material-icons {
            display: block;
            font-size: 4rem;
            margin-bottom: 15px;
            color: #a4b0c6;
            opacity: 0.7;
        }

        /* --- Custom: Subtle input autofill fix for Chrome --- */
        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 100px #f7fafd inset !important;
            -webkit-text-fill-color: #22334d !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* --- Custom: Hide number input arrows for date fields --- */
        input[type=date]::-webkit-inner-spin-button, input[type=date]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=date] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <h1>Simple Task Manager</h1>

    <div class="task-form">
        <input type="text" id="description" placeholder="Task Description" required aria-label="Task Description">
        <span class="error-message" id="descriptionError"></span>

        <input type="date" id="dueDate" required aria-label="Due Date">
        <span class="error-message" id="dueDateError"></span>

        <div class="inline">
            <select id="type" aria-label="Task Type"></select>
            <input type="text" id="newType" placeholder="Add new type (optional)" aria-label="Add new type">
        </div>
        <select id="priority" aria-label="Task Priority">
            <option value="Urgent">Urgent</option>
            <option value="High">High</option>
            <option value="Medium" selected>Medium</option>
            <option value="Low">Low</option>
        </select>
        <!-- Subtasks input -->
        <div id="subtasksContainer">
            <input type="text" id="subtaskInput" placeholder="Add subtask and press Enter" aria-label="Add subtask">
            <ul id="subtasksList"></ul>
        </div>
        <button onclick="addTask()" aria-label="Add New Task">
            <span class="material-icons" style="vertical-align:middle;margin-right:6px;font-size:1.2em;">add_circle</span>
            Add Task
        </button>
    </div>

    <div class="controls">
        <input type="text" id="searchTasks" placeholder="Search tasks..." onkeyup="searchTasks()" aria-label="Search tasks by description">
        <select id="filter" onchange="filterTasks()" aria-label="Filter Tasks">
            <option value="all">Show All</option>
            <option value="completed">Show Completed</option>
            <option value="pending">Show Pending</option>
        </select>
        <select id="sort" onchange="sortTasks()" aria-label="Sort Tasks">
            <option value="dueDate">Sort by Due Date</option>
            <option value="priority">Sort by Priority</option>
        </select>
        <button id="clearCompletedBtn" aria-label="Clear all completed tasks">
            <span class="material-icons">task_alt</span>
            Clear Completed
        </button>
    </div>

    <div class="task-list" id="taskList"></div>

    <div class="modal-overlay" id="deleteConfirmModal" style="display: none;">
        <div class="modal-box">
            <p><span class="material-icons" style="color:#e53935;font-size:2.2rem;vertical-align:middle;">warning</span><br>Are you sure you want to delete this task?</p>
            <button id="yes" aria-label="Confirm Delete">Yes</button>
            <button id="no" aria-label="Cancel Delete">No</button>
        </div>
    </div>

    <div class="modal-overlay" id="clearCompletedConfirmModal" style="display: none;">
        <div class="modal-box">
            <p><span class="material-icons" style="color:#f57c00;font-size:2.2rem;vertical-align:middle;">help_outline</span><br>Clear all completed tasks?</p>
            <button id="confirmClear" aria-label="Confirm Clear Completed">Yes, Clear All</button>
            <button id="cancelClear" aria-label="Cancel Clear Completed">No, Keep Them</button>
        </div>
    </div>

    <div class="modal-overlay" id="editTaskModal" style="display: none;">
        <div class="modal-box edit-modal">
            <h2>Edit Task</h2>
            <label for="editDescription">Description:</label>
            <input type="text" id="editDescription" required aria-label="Edit Task Description">
            <label for="editDueDate">Due Date:</label>
            <input type="date" id="editDueDate" required aria-label="Edit Due Date">
            <label for="editType">Type:</label>
            <select id="editType" aria-label="Edit Task Type"></select>
            <label for="editPriority">Priority:</label>
            <select id="editPriority" aria-label="Edit Task Priority">
                <option value="Urgent">Urgent</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
            <div class="modal-buttons">
                <button id="saveEdit" aria-label="Save Changes">Save Changes</button>
                <button id="cancelEdit" aria-label="Cancel Edit">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        /* --- Data & State --- */
        let defaultTypes = ["Home", "School", "Work"]; // Now dynamically updated
        let tasks = [];
        let currentFilter = 'all';
        let currentSort = 'dueDate';
        let currentSearchTerm = ''; // New state for search
        let subtasks = [];
        const subtaskInput = document.getElementById('subtaskInput');
        const subtasksList = document.getElementById('subtasksList');

        subtaskInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && subtaskInput.value.trim()) {
                subtasks.push({ text: subtaskInput.value.trim(), done: false });
                subtaskInput.value = '';
                renderSubtasks();
            }
        });
        function renderSubtasks() {
            subtasksList.innerHTML = '';
            subtasks.forEach((st, i) => {
                const li = document.createElement('li');
                li.innerHTML = `<input type='checkbox' ${st.done ? 'checked' : ''} onclick='toggleSubtask(${i})'> ${st.text} <button onclick='removeSubtask(${i})' style='color:#e53935;border:none;background:none;'>×</button>`;
                subtasksList.appendChild(li);
            });
        }
        window.toggleSubtask = function(i) {
            subtasks[i].done = !subtasks[i].done;
            renderSubtasks();
        }
        window.removeSubtask = function(i) {
            subtasks.splice(i,1);
            renderSubtasks();
        }

        let taskIdToDelete = null; // To store ID for delete confirmation
        let taskIdToEdit = null; // To store ID for edit modal

        /* --- DOM Elements --- */
        const descriptionInput = document.getElementById('description');
        const dueDateInput = document.getElementById('dueDate');
        const typeSelect = document.getElementById('type');
        const newTypeInput = document.getElementById('newType');
        const prioritySelect = document.getElementById('priority');
        const taskForm = document.querySelector('.task-form');

        const descError = document.getElementById('descriptionError');
        const dueDateError = document.getElementById('dueDateError');

        const filterSelect = document.getElementById('filter');
        const sortSelect = document.getElementById('sort');
        const searchInput = document.getElementById('searchTasks'); // New search input

        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('yes');
        const cancelDeleteBtn = document.getElementById('no');

        const clearCompletedConfirmModal = document.getElementById('clearCompletedConfirmModal');
        const confirmClearBtn = document.getElementById('confirmClear');
        const cancelClearBtn = document.getElementById('cancelClear');
        const clearCompletedTasksBtn = document.getElementById('clearCompletedBtn');


        const editTaskModal = document.getElementById('editTaskModal');
        const editDescriptionInput = document.getElementById('editDescription');
        const editDueDateInput = document.getElementById('editDueDate');
        const editTypeSelect = document.getElementById('editType');
        const editPrioritySelect = document.getElementById('editPriority');
        const saveEditBtn = document.getElementById('saveEdit');
        const cancelEditBtn = document.getElementById('cancelEdit');


        /* --- Utility Functions --- */
        function populateTypes(targetSelect = typeSelect, currentType = null) {
            const allTypes = [...new Set(defaultTypes.concat(tasks.map(t => t.type)))].sort();
            const existingOptions = Array.from(targetSelect.options).map(opt => opt.value);

            // Clear only if the target is edit modal or if options have changed significantly
            if (targetSelect === editTypeSelect || allTypes.length !== existingOptions.length || !allTypes.every(type => existingOptions.includes(type))) {
                targetSelect.innerHTML = '';
                allTypes.forEach(type => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = type;
                    targetSelect.appendChild(opt);
                });
            } else {
                 // For the main type select, just ensure all types are present without full rebuild
                allTypes.forEach(type => {
                    if (!existingOptions.includes(type)) {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = type;
                        targetSelect.appendChild(opt);
                    }
                });
            }


            // Select the provided current type if in edit mode
            if (currentType && allTypes.includes(currentType)) {
                targetSelect.value = currentType;
            } else if (targetSelect === typeSelect) {
                // For main add form, restore last selected if available, or default
                const lastSelectedType = localStorage.getItem('lastSelectedType');
                if (lastSelectedType && allTypes.includes(lastSelectedType)) {
                    targetSelect.value = lastSelectedType;
                } else {
                    targetSelect.value = defaultTypes.includes("Work") ? "Work" : allTypes[0];
                }
            }
        }

        function saveTasks() {
            try {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('defaultTypes', JSON.stringify(defaultTypes)); // Save types too
                localStorage.setItem('currentFilter', currentFilter); // Save filter
                localStorage.setItem('currentSort', currentSort);     // Save sort
                localStorage.setItem('currentSearchTerm', currentSearchTerm); // Save search term
                localStorage.setItem('lastSelectedType', typeSelect.value); // Save last selected type
            } catch (e) {
                console.error('Saving failed', e);
            }
        }

        function loadTasks() {
            try {
                tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                defaultTypes = JSON.parse(localStorage.getItem('defaultTypes')) || ["Home", "School", "Work"];
                currentFilter = localStorage.getItem('currentFilter') || 'all';
                currentSort = localStorage.getItem('currentSort') || 'dueDate';
                currentSearchTerm = localStorage.getItem('currentSearchTerm') || '';

            } catch (e) {
                console.error('Loading failed', e);
                tasks = [];
                defaultTypes = ["Home", "School", "Work"];
                currentFilter = 'all';
                currentSort = 'dueDate';
                currentSearchTerm = '';
            }
            // Set values to DOM elements based on loaded state
            filterSelect.value = currentFilter;
            sortSelect.value = currentSort;
            searchInput.value = currentSearchTerm;

            populateTypes(); // Populate types for main form
            renderTasks();
            setTodayDate(); // Set default date on load
        }

        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            const todayFormatted = `${yyyy}-${mm}-${dd}`;
            dueDateInput.value = todayFormatted;
        }

        function showValidationMessage(inputElement, errorMessageElement, message) {
            inputElement.classList.add('error');
            errorMessageElement.textContent = message;
            errorMessageElement.classList.add('active');
        }

        function clearValidationMessage(inputElement, errorMessageElement) {
            inputElement.classList.remove('error');
            errorMessageElement.textContent = '';
            errorMessageElement.classList.remove('active');
        }


        /* --- Task CRUD --- */
        function addTask() {
            let isValid = true;
            const desc = descriptionInput.value.trim();
            const due = dueDateInput.value;
            let selectedType = typeSelect.value;
            const newType = newTypeInput.value.trim();
            const priority = prioritySelect.value;

            // Validate Description
            if (!desc) {
                showValidationMessage(descriptionInput, descError, 'Task description is required.');
                isValid = false;
            } else {
                clearValidationMessage(descriptionInput, descError);
            }

            // Validate Due Date
            if (!due) {
                showValidationMessage(dueDateInput, dueDateError, 'Due date is required.');
                isValid = false;
            } else {
                clearValidationMessage(dueDateInput, dueDateError);
            }

            if (!isValid) return; // Stop if validation failed

            // Handle new type addition
            if (newType) {
                selectedType = newType;
                if (!defaultTypes.includes(newType)) {
                    defaultTypes.push(newType);
                    defaultTypes.sort();
                    populateTypes();
                }
            }
            // Attach subtasks to the task
            const task = { id: Date.now(), description: desc, dueDate: due, type: selectedType, priority, completed: false, subtasks: subtasks.slice() };
            tasks.push(task);
            saveTasks();
            renderTasks();
            taskForm.reset();
            setTodayDate();
            newTypeInput.value = '';
            typeSelect.value = selectedType;
            subtasks = [];
            renderSubtasks();
        }

        function toggleComplete(id) {
            const t = tasks.find(x => x.id === id);
            if (t) {
                t.completed = !t.completed;
            }
            saveTasks();
            renderTasks();
        }

        function deleteTask(id) {
            taskIdToDelete = id; // Store ID for confirmation
            deleteConfirmModal.style.display = 'flex';
        }

        confirmDeleteBtn.onclick = () => {
            // Add a deleting class to the task item for animation before removal
            const taskElement = document.querySelector(`.task-item[data-id="${taskIdToDelete}"]`);
            if (taskElement) {
                taskElement.classList.add('deleting');
                taskElement.addEventListener('transitionend', () => {
                    tasks = tasks.filter(x => x.id !== taskIdToDelete);
                    saveTasks();
                    renderTasks(); // Re-render after item is fully hidden
                    deleteConfirmModal.style.display = 'none';
                    taskIdToDelete = null;
                }, { once: true });
            } else {
                // Fallback if element not found (e.g., if already removed)
                tasks = tasks.filter(x => x.id !== taskIdToDelete);
                saveTasks();
                renderTasks();
                deleteConfirmModal.style.display = 'none';
                taskIdToDelete = null;
            }
        };

        cancelDeleteBtn.onclick = () => {
            deleteConfirmModal.style.display = 'none';
            taskIdToDelete = null;
        };

        function showEditTaskModal(id) {
            taskIdToEdit = id;
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            editDescriptionInput.value = task.description;
            editDueDateInput.value = task.dueDate;
            populateTypes(editTypeSelect, task.type); // Populate and select current type for edit modal
            editPrioritySelect.value = task.priority;

            editTaskModal.style.display = 'flex';
        }

        saveEditBtn.onclick = () => {
            const task = tasks.find(t => t.id === taskIdToEdit);
            if (!task) return;

            const newDesc = editDescriptionInput.value.trim();
            const newDate = editDueDateInput.value;
            const newType = editTypeSelect.value;
            const newPri = editPrioritySelect.value;

            if (!newDesc || !newDate || !newType || !newPri) {
                // For edit modal, consider adding inline validation as well if time permits
                alert('All fields are required for editing.');
                return;
            }

            task.description = newDesc;
            task.dueDate = newDate;
            task.type = newType;
            task.priority = newPri;

            // Ensure the edited type is in defaultTypes
            if (!defaultTypes.includes(newType)) {
                defaultTypes.push(newType);
                defaultTypes.sort(); // Keep types sorted
                populateTypes(); // Update main form types if a new one was added
            }

            saveTasks();
            renderTasks();
            editTaskModal.style.display = 'none';
            taskIdToEdit = null;
        };

        cancelEditBtn.onclick = () => {
            editTaskModal.style.display = 'none';
            taskIdToEdit = null;
        };

        function clearCompletedTasks() {
            clearCompletedConfirmModal.style.display = 'flex';
        }

        confirmClearBtn.onclick = () => {
            tasks = tasks.filter(t => !t.completed);
            saveTasks();
            renderTasks();
            clearCompletedConfirmModal.style.display = 'none';
        };

        cancelClearBtn.onclick = () => {
            clearCompletedConfirmModal.style.display = 'none';
        };

        // Subtask toggle for tasks in the list
        window.toggleTaskSubtask = function(taskId, subIdx) {
            const t = tasks.find(x => x.id === taskId);
            if (t && t.subtasks && t.subtasks[subIdx]) {
                t.subtasks[subIdx].done = !t.subtasks[subIdx].done;
                saveTasks();
                renderTasks();
            }
        }

        /* --- Render & Controls --- */
        function renderTasks() {
            let arr = tasks.slice();

            // Apply search filter first
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                arr = arr.filter(t =>
                    t.description.toLowerCase().includes(searchTermLower) ||
                    t.type.toLowerCase().includes(searchTermLower)
                );
            }

            // Apply completion filter
            if (currentFilter === 'completed') arr = arr.filter(x => x.completed);
            if (currentFilter === 'pending') arr = arr.filter(x => !x.completed);

            // Apply sort
            if (currentSort === 'dueDate') {
                arr.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            } else if (currentSort === 'priority') {
                const order = { Urgent: 4, High: 3, Medium: 2, Low: 1 };
                arr.sort((a, b) => order[b.priority] - order[a.priority]);
            }

            const c = document.getElementById('taskList');
            c.innerHTML = ''; // Clear existing tasks

            if (!arr.length) {
                c.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">assignment_turned_in</span>
                        <p>No tasks found for the current criteria.<br>Add a new task or adjust your filters/search!</p>
                    </div>
                `;
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            arr.forEach(t => {
                const el = document.createElement('div');
                let additionalClasses = '';
                // Due Date Highlighting Logic
                const taskDueDate = new Date(t.dueDate);
                taskDueDate.setHours(0, 0, 0, 0);
                if (taskDueDate < today && !t.completed) {
                    additionalClasses += ' overdue';
                } else if (taskDueDate >= today && (taskDueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24) <= 3 && !t.completed) {
                    additionalClasses += ' due-soon';
                }
                el.className = `task-item priority-${t.priority}${t.completed ? ' completed' : ''}${additionalClasses}`;
                el.setAttribute('data-id', t.id);
                // Subtasks progress bar
                let subtaskBar = '';
                if (t.subtasks && t.subtasks.length) {
                    const done = t.subtasks.filter(st => st.done).length;
                    const percent = Math.round((done / t.subtasks.length) * 100);
                    subtaskBar = `<div style='margin:8px 0 0 0;'><div style='height:8px;width:100%;background:#e3eafc;border-radius:4px;overflow:hidden;'><div style='height:8px;width:${percent}%;background:#43a047;transition:width 0.3s;'></div></div><small style='color:#7b8a9c;'>${done}/${t.subtasks.length} subtasks done</small></div>`;
                }
                // Subtasks checklist
                let subtasksHtml = '';
                if (t.subtasks && t.subtasks.length) {
                    subtasksHtml = `<ul style='margin:8px 0 0 0;padding-left:18px;'>` + t.subtasks.map((st, i) =>
                        `<li><input type='checkbox' ${st.done ? 'checked' : ''} onclick='toggleTaskSubtask(${t.id},${i})'> ${st.text}</li>`
                    ).join('') + `</ul>`;
                }
                el.innerHTML = `
                    <div class="task-header">
                        <div>
                            <strong>${t.description}</strong>
                            <small>
                                <span class="material-icons" style="font-size:1em;vertical-align:middle;color:#3b82f6;">event</span>
                                ${t.dueDate}
                                &nbsp;|&nbsp;
                                <span class="material-icons" style="font-size:1em;vertical-align:middle;color:#43a047;">category</span>
                                ${t.type}
                                &nbsp;|&nbsp;
                                <span class="material-icons" style="font-size:1em;vertical-align:middle;color:#fbc02d;">flag</span>
                                ${t.priority}
                            </small>
                            ${subtaskBar}
                        </div>
                        <div class="task-actions">
                            <label title="Mark as complete">
                                <input type="checkbox" ${t.completed ? 'checked' : ''} onclick="toggleComplete(${t.id})" aria-label="Mark task as complete">
                            </label>
                            <button onclick="showEditTaskModal(${t.id})" title="Edit Task" aria-label="Edit Task">
                                <span class="material-icons">edit</span>
                            </button>
                            <button onclick="deleteTask(${t.id})" title="Delete Task" aria-label="Delete Task">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    ${subtasksHtml}
                `;
                c.appendChild(el);
            });
        }

        /* --- Filter, Sort, and Search --- */
        function filterTasks() {
            currentFilter = filterSelect.value;
            saveTasks();
            renderTasks();
        }

        function sortTasks() {
            currentSort = sortSelect.value;
            saveTasks();
            renderTasks();
        }

        function searchTasks() {
            currentSearchTerm = searchInput.value.trim();
            saveTasks();
            renderTasks();
        }

        /* --- Initial Load --- */
        loadTasks();
    </script>
</body>
</html>